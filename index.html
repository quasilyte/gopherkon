<meta charset="utf-8">

<style>
* {
    font-size: 13px;
    color: #335d7b;
    font-family: -apple-system,BlinkMacSystemFont,Roboto,Open Sans,Helvetica Neue,sans-serif;
    font-weight: 400;
}

body {
    background-color: #edeef0;
    margin: 0;
}

.back {
    width: 100%;
    background: #4a76a8;
    height: 42px;
    padding-left: 16px;
    border-bottom: 1px solid #4872a3;
    margin-bottom: 8px;
    line-height: 42px;
}

#selfref {
    font-size: 16pt;
    text-decoration: none;
    color: white !important;
    font-weight: 600;
}

.controlref {
    font-size: 13pt;
    color: #c0cfe1 !important;
    padding: 6px;
    background-color: #224b7a;
    border-radius: 14px;
}

#gopher {
    width: 490px;
    height: 460px;
    overflow: hidden;
    position: relative;
    background-color: #fff;
    border-radius: 4px;
    box-shadow: 0 1px 0 0 #d7d8db, 0 0 0 1px #e3e4e8;
}

#option-tabs {
    width: 342px;
    height: 444px;
    border-radius: 4px;
    box-shadow: 0 1px 0 0 #d7d8db, 0 0 0 1px #e3e4e8;
    padding: 8px;
}

#tab-selector {
    background-color: #fff;
    border-radius: 4px;
    box-shadow: 0 1px 0 0 #d7d8db, 0 0 0 1px #e3e4e8;
}

.image-layer {
    position: absolute;
}

td {
    padding: 0;
}

td a {
    text-decoration: none;
    display: block;
    padding-left: 18px;
    line-height: 31px;
    width: 96px;
}

td a:hover {
    background-color: #f0f2f5;
}

.option-link img:hover {
    background-color: #f0f2f5;
}

.option-link img {
    text-decoration: none;
    width: 110px;
    height: auto;
    border-bottom: 1px solid #dfe2e8;
    background-color: #fff;
}

.option-tab {
    display: none;
    overflow-y: scroll;
    width: 100%;
    height: 100%;
    background-color: #fff;
}

.option-selected {
    background-color: #f0f2f5 !important;
}

.tab-selected {
    background-color: #f0f2f5;
    border-left: 2px solid #5181b8;
    color: black;
    font-weight: 500;
    padding-left: 16px;
}

</style>

<div class="back">
    <a id="selfref" href="">Gopher Konstructor</a>
    <a style="margin-left: 16px" id="download" class="controlref" href="" download="gopher.png">Download PNG</a>
    <a class="controlref" title="Produced images are free for any use" href="https://github.com/quasilyte/quasilyte.github.io/blob/master/gopherkon/LICENSE">See license</a>
</div>

<div style="width: 1100px; height: 490px; margin-left: 16px">
    <canvas width=490 height=460 style="position: relative; float: left" id="gopher"></canvas>

    <div id="option-tabs" style="float: left">
        <div id="colorOptionTab" class="option-tab"></div>
        <div id="eyesOptionTab" class="option-tab"></div>
        <div id="poseOptionTab" class="option-tab"></div>
        <div id="torsoOptionTab" class="option-tab"></div>
        <div id="earsOptionTab" class="option-tab"></div>
        <div id="noseOptionTab" class="option-tab"></div>
        <div id="undernoseOptionTab" class="option-tab"></div>
        <div id="teethsOptionTab" class="option-tab"></div>    
        <div id="mouthOptionTab" class="option-tab"></div>    
        <div id="accessoryOptionTab" class="option-tab"></div>
        <div id="extrasOptionTab" class="option-tab"></div>
        <div id="tattooOptionTab" class="option-tab"></div>
    </div>

    <div style="margin-left: 8px; float: left">
        <table cellspacing="0" id="tab-selector"></table>
    </div>
</div>

<script>
var app = (function() {
    function decodeWord(s) {
        s = ""+s; // Ensure it's string.
        return parseInt(s, 16);
    }

    function encodeWord(num) {
        num = num|0; // Ensure it's number.
        s = num.toString(16);
        if (s.length == 2) {
            return s;
        }
        if (s.length == 1) {
            return "0" + s;
        }
        console.error("bad num: %d", num);
        return "0";
    }

    var gopherExtrasList = [
        "sprites/none.png",
        "sprites/extras/bowtie.png",
    ];

    var gopherTeethsList = [
        "sprites/none.png",
        "sprites/teeths/classical.png",
        "sprites/teeths/edgy.png",
        "sprites/teeths/fangs.png",
        "sprites/teeths/fragile.png",
        "sprites/teeths/funky.png",
        "sprites/teeths/shy.png",
        "sprites/teeths/soft.png",
    ];

    var gopherMouthList = [
        "sprites/none.png",
        "sprites/mouth/grin.png",
        "sprites/mouth/lol.png",
        "sprites/mouth/shout.png",
        "sprites/mouth/surprised.png",
        "sprites/mouth/tongue.png",
    ];

    var gopherColorsList = [
        "sprites/torso/normal/0.png",
        "sprites/torso/normal/5.png",
        "sprites/torso/normal/10.png",
        "sprites/torso/normal/15.png",
        "sprites/torso/normal/40.png",
        "sprites/torso/normal/75.png",
        "sprites/torso/normal/80.png",
        "sprites/torso/normal/85.png",
        "sprites/torso/normal/90.png",
        "sprites/torso/normal/95.png",
        "sprites/torso/normal/100.png",
        "sprites/torso/normal/105.png",
        "sprites/torso/normal/110.png",
        "sprites/torso/normal/115.png",
        "sprites/torso/normal/125.png",
        "sprites/torso/normal/145.png",
        "sprites/torso/normal/150.png",
        "sprites/torso/normal/155.png",
        "sprites/torso/normal/170.png",
        "sprites/torso/normal/180.png",
        "sprites/torso/normal/195.png",
    ];

    var gopherEarsList = [
        "sprites/none.png",
        "sprites/ears/fancy",
        "sprites/ears/fluffy",
        "sprites/ears/foxy",
        "sprites/ears/normal",
        "sprites/ears/playful",
        "sprites/ears/pointy",
        "sprites/ears/tiny",
        "sprites/ears/wide",
        "sprites/ears/wolf",
    ];

    var gopherTorsoList = [
        "sprites/none.png",
        "sprites/torso/cheeky",
        "sprites/torso/curly",
        "sprites/torso/normal",
        "sprites/torso/shaggy",
        "sprites/torso/wolf",
        "sprites/torso/barbed",
    ];

    var gopherPoseList = [
        "sprites/none.png",
        "sprites/pose/cowboy.png",
        "sprites/pose/dunno.png",
        "sprites/pose/right_holding.png",
        "sprites/pose/right_holding.mic.png",
        "sprites/pose/right_holding.white_rose.png",
        "sprites/pose/right_holding.wrench.png",
        "sprites/pose/sides.png",
        "sprites/pose/sign_blank.png",
        "sprites/pose/sign_persik_happy.png",
        "sprites/pose/sign_persik_laugh.png",
        "sprites/pose/sign_persik_thumbsup.png",
        "sprites/pose/sign_persik_angry.png",
        "sprites/pose/sign_go.png",
        "sprites/pose/sign_linux.png",
        "sprites/pose/sign_linux.png",
        "sprites/pose/sign_vkcom.png",
        "sprites/pose/thinking.magnifier.png",
        "sprites/pose/thinking.png",
        "sprites/pose/timid.beads.png",
        "sprites/pose/timid.camera.png",
        "sprites/pose/timid.coffee.png",
        "sprites/pose/timid.money.png",
        "sprites/pose/timid.png",
    ];

    var gopherNoseList = [
        "sprites/nose/neat_a.png",
        "sprites/nose/neat_b.png",
        "sprites/nose/oval.png",
        "sprites/nose/round.png",
        "sprites/nose/small.png",
        "sprites/nose/tiny.png",
    ];

    var gopherAccessoryList = [
        "sprites/none.png",
        "sprites/accessory/censored_black.png",
        "sprites/accessory/censored_red.png",
        "sprites/accessory/glasses_cool.png",
        "sprites/accessory/deal_with_it.png",
        "sprites/accessory/glasses_hipster.png",
        "sprites/accessory/glasses_glam.png",
        "sprites/accessory/glasses_nerd.png",
        "sprites/accessory/glasses_square.png",
    ];

    var gopherEyesList = [
        "sprites/eyes/alien_center.png",
        "sprites/eyes/alien_crazy.png",
        "sprites/eyes/alien_fish.png",
        "sprites/eyes/angry.png",
        "sprites/eyes/angry_one.png",
        "sprites/eyes/confused.png",
        "sprites/eyes/different.png",
        "sprites/eyes/different_mirrored.png",
        "sprites/eyes/different_mirrored_eyebrow.png",
        "sprites/eyes/distant_normal_left.png",
        "sprites/eyes/happy.png",
        "sprites/eyes/happy_as_in_anime.png",
        "sprites/eyes/killed.png",
        "sprites/eyes/normal_up.png",
        "sprites/eyes/normal_up_lashes.png",
        "sprites/eyes/oval_center.png",
        "sprites/eyes/oval_center_lashes.png",
        "sprites/eyes/oval_crazy.png",
        "sprites/eyes/oval_curious.png",
        "sprites/eyes/oval_curious_empty.png",
        "sprites/eyes/oval_down.png",
        "sprites/eyes/oval_down_lashes.png",
        "sprites/eyes/rofl.png",
        "sprites/eyes/sceptical.png",
        "sprites/eyes/small_center.png",
        "sprites/eyes/small_center_lashes.png",
        "sprites/eyes/wink.png",
    ];

    var gopherUndernoseList = [
        "sprites/undernose/normal.png",
        "sprites/undernose/oval.png",
        "sprites/undernose/rome.png",
        "sprites/undernose/small.png",
    ];

    var gopherTattooList = [
        "sprites/none.png",
        "sprites/tattoo/apple.png",
        "sprites/tattoo/batman.png",
        "sprites/tattoo/digital_resistance1.png",
        "sprites/tattoo/digital_resistance2.png",
        "sprites/tattoo/durov_dog1.png",
        "sprites/tattoo/durov_dog2.png",
        "sprites/tattoo/github.png",
        "sprites/tattoo/invader.png",
        "sprites/tattoo/sammy.png",
        "sprites/tattoo/sekai.png",
        "sprites/tattoo/slowpoke.png",
        "sprites/tattoo/ubuntu.png",
        "sprites/tattoo/usb.png",
        "sprites/tattoo/vk.png",
        "sprites/tattoo/x.png",
    ];

    var optionTabList = [
        {
            key: "colorOptionTab",
            options: gopherColorsList,
            label: "Body color",
        },
        {
            key: "eyesOptionTab",
            options: gopherEyesList,
            label: "Eyes",
        },
        {
            key: "poseOptionTab",
            options: gopherPoseList,
            label: "Pose",
        },
        {
            key: "torsoOptionTab",
            options: gopherTorsoList,
            label: "Torso",
        },
        {
            key: "earsOptionTab",
            options: gopherEarsList,
            label: "Ears",
        },
        {
            key: "teethsOptionTab",
            options: gopherTeethsList,
            label: "Teeths",
        },
        {
            key: "mouthOptionTab",
            options: gopherMouthList,
            label: "Mouth",
        },
        {
            key: "undernoseOptionTab",
            options: gopherUndernoseList,
            label: "Undernose",    
        },
        {
            key: "noseOptionTab",
            options: gopherNoseList,
            label: "Nose",    
        },
        {
            key: "accessoryOptionTab",
            options: gopherAccessoryList,
            label: "Accessory",
        },
        {
            key: "tattooOptionTab",
            options: gopherTattooList,
            label: "Tattoo",
        },
        {
            key: "extrasOptionTab",
            options: gopherExtrasList,
            label: "Extras",
        },
    ];

    function objectListFmt(list) {
        return {
            enc: function(x) {
                for (var i in list) {
                    if (list[i].key == x.key) {
                        return encodeWord(i);
                    }                    
                }
                console.error("%s not found", x.key);
                return encodeWord(0);
            },
            dec: function(s) { return list[decodeWord(s)]; },
        };
    }
    function stringListFmt(list) {
        return {
            enc: function(s) { return encodeWord(list.indexOf(s)); },
            dec: function(s) { return list[decodeWord(s)]; },
        };
    }

    var app = {
        query: new URLSearchParams(window.location.search),

        state: {
            tabSelection: optionTabList,

            // Defaults.
            tab: optionTabList[0],
            colorOptionTab: "sprites/torso/normal/100.png",
            eyesOptionTab: "sprites/eyes/normal_up.png",
            poseOptionTab: "sprites/pose/dunno.png",
            torsoOptionTab: "sprites/torso/normal",
            earsOptionTab: "sprites/ears/normal",
            teethsOptionTab: "sprites/teeths/classical.png",
            mouthOptionTab: "sprites/none.png",
            undernoseOptionTab: "sprites/undernose/normal.png",
            noseOptionTab: "sprites/nose/oval.png",
            accessoryOptionTab: "sprites/none.png",
            tattooOptionTab: "sprites/none.png",
            extrasOptionTab: "sprites/none.png",
        },

        stateScheme: [
            {name: "tab", fmt: objectListFmt(optionTabList)},
            {name: "colorOptionTab", fmt: stringListFmt(gopherColorsList)},
            {name: "eyesOptionTab", fmt: stringListFmt(gopherEyesList)},
            {name: "poseOptionTab", fmt: stringListFmt(gopherPoseList)},
            {name: "torsoOptionTab", fmt: stringListFmt(gopherTorsoList)},
            {name: "earsOptionTab", fmt: stringListFmt(gopherEarsList)},
            {name: "teethsOptionTab", fmt: stringListFmt(gopherTeethsList)},
            {name: "mouthOptionTab", fmt: stringListFmt(gopherMouthList)},
            {name: "undernoseOptionTab", fmt: stringListFmt(gopherUndernoseList)},
            {name: "noseOptionTab", fmt: stringListFmt(gopherNoseList)},
            {name: "accessoryOptionTab", fmt: stringListFmt(gopherAccessoryList)},
            {name: "tattooOptionTab", fmt: stringListFmt(gopherTattooList)},
            {name: "extrasOptionTab", fmt: stringListFmt(gopherExtrasList)},
        ],
    };
    return app;
}());

app.stateString = function(delta) {
    delta = delta || {};
    var parts = [];
    for (var i in app.stateScheme) {
        var desc = app.stateScheme[i];
        var val = delta[desc.name] || app.state[desc.name];
        parts.push(desc.fmt.enc(val));
    }
    return parts.join("");
};

// Try loading state from the "state" GET param or
// initialize app with default state.
app.loadState = function() {
    var state = app.query.get("state");
    if (!state) {
        return;
    }
    var parts = state.match(/.{2}/g);
    if (parts.length != app.stateScheme.length) {
        console.error("corrupted state param: have %d chunks, want %d",
            parts.length, app.stateScheme.length);
        return;
    }
    for (var i in app.stateScheme) {
        var desc = app.stateScheme[i];
        app.state[desc.name] = desc.fmt.dec(parts[i]);
    }
};

app.initOptionTabSelector = function() {
    var tabInfo = app.state.tab;
    var tabSelector = document.getElementById("tab-selector");

    var parts = [];
    var tabSelection = app.state.tabSelection;
    for (var i in tabSelection) {
        var href = "";
        var label = tabSelection[i].label;
        var href = "?state=" + app.stateString({tab: tabSelection[i]});
        if (tabInfo == tabSelection[i]) {
            parts.push("<tr><td><a class='tab-selected' href='"+href+"'>"+label+"</a></td></tr>")
        } else {
            parts.push("<tr><td><a href='"+href+"'>"+label+"</a></td></tr>")
        }
    }
    tabSelector.innerHTML = parts.join("");
};

app.initOptionTab = function() {
    var tabInfo = app.state.tab;
    var optionTab = document.getElementById(tabInfo.key);

    optionTab.style.display = "block";

    var parts = [];
    var tabKey = app.state.tab.key;
    for (var i in tabInfo.options) {
        var imgURL = app.spriteURL(tabInfo.options[i]);
        var delta = {};
        delta[tabKey] = tabInfo.options[i];
        var href = "?state=" + app.stateString(delta);
        if (app.state[tabKey] == tabInfo.options[i]) {
            parts.push("<a class='option-link' href='"+href+"'><img class='option-selected' src='"+imgURL+"'></a>");
        } else {
            parts.push("<a class='option-link' href='"+href+"'><img src='"+imgURL+"'></a>");
        }
    }
    optionTab.innerHTML = parts.join("");
};

app.spriteURL = function(url) {
    if (url.endsWith(".png")) {
        return url;
    }
    var parts = app.state.colorOptionTab.split("/");
    var suffix = parts[parts.length-1];
    return url + "/" + suffix;
};

app.drawImages = function(images) {
    var canvas = document.getElementById("gopher");
    var ctx = canvas.getContext("2d");
    for (i in images) {
        var img = images[i];
        ctx.drawImage(img, 0, 0);
    }
};

app.renderGopher = function() {
    var drawOrder = [
        "earsOptionTab",
        "torsoOptionTab",
        "extrasOptionTab",
        "eyesOptionTab",
        "mouthOptionTab",
        "teethsOptionTab",
        "undernoseOptionTab",
        "noseOptionTab",
        "tattooOptionTab",
        "poseOptionTab",
        "accessoryOptionTab",
    ];

    var images = [];
    var toLoad = drawOrder.length; // For sync.
    for (var i in drawOrder) {
        var tabKey = drawOrder[i];
        var imgURL = app.spriteURL(app.state[tabKey]);
        if (!imgURL) {
            toLoad--;
            continue;
        }
        var img = new Image();
        images.push(img); // Order is preserved.
        img.src = imgURL;
        img.onload = function() {
            toLoad--;
            if (toLoad == 0) {
                app.drawImages(images);
            }
        };
    }
};

app.initDownload = function() {
    var link = document.getElementById("download");

    download.onclick = function() {
        link.href = document.getElementById("gopher").toDataURL("image/png;base64");
    };
};

app.main = function() {
    app.loadState();
    console.debug("decoded state:", app.state);
    console.debug("state string:", app.stateString({}));
    app.initOptionTabSelector();
    app.initOptionTab();
    app.renderGopher();
    app.initDownload();
};

window.onload = function() { app.main(); };
</script>
